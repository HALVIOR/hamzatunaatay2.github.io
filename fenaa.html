<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Tuna Galeri: Pro Drive & Modify</title>
<style>
    :root { --bg: #080808; --gold: #f1c40f; --blue: #00d2ff; --red: #ff4757; }
    body { margin: 0; background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; }
    
    /* HUD & UI */
    .overlay { position: fixed; top: 0; width: 100%; padding: 20px; display: flex; justify-content: space-around; background: linear-gradient(to bottom, #000, transparent); z-index: 10; }
    .stat-card { background: rgba(20,20,20,0.8); padding: 10px 20px; border-radius: 12px; border-bottom: 3px solid var(--blue); }
    
    .game-grid { display: grid; grid-template-columns: 260px 1fr 320px; height: 100vh; padding-top: 80px; gap: 20px; padding: 80px 20px 20px; }
    
    /* Yan Paneller */
    .panel { background: #111; border-radius: 20px; border: 1px solid #222; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
    .nav-btn { background: #1a1a1a; border: 1px solid #333; color: #fff; padding: 15px; border-radius: 12px; cursor: pointer; transition: 0.3s; text-align: left; }
    .nav-btn:hover, .nav-btn.active { background: var(--blue); color: #000; font-weight: bold; }

    /* Ana Sahne */
    .viewport { background: #000; border-radius: 30px; border: 2px solid #333; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; }
    
    /* NPC & Dialog */
    #npc-box { text-align: center; max-width: 400px; z-index: 5; }
    .bubble { background: #fff; color: #000; padding: 20px; border-radius: 20px; margin-bottom: 20px; font-weight: 600; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .bubble:after { content:''; position:absolute; bottom:-15px; left:50%; border:15px solid transparent; border-top-color:#fff; transform:translateX(-50%); }

    /* Modifiye & Drive Settings */
    #setup-ui { position: absolute; background: rgba(0,0,0,0.9); padding: 30px; border-radius: 25px; border: 2px solid var(--gold); text-align: center; display: none; z-index: 20; }
    .btn { border: none; padding: 12px 20px; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.2s; }
    .btn-gold { background: var(--gold); color: #000; }
    .btn-blue { background: var(--blue); color: #000; }

    canvas { display: none; width: 100%; height: 100%; }
    #drive-hud { position: absolute; bottom: 30px; width: 100%; text-align: center; display: none; pointer-events: none; }
</style>
</head>
<body>

    <div class="overlay">
        <div class="stat-card">ğŸ’° <span id="u-money">500,000</span> â‚º</div>
        <div class="stat-card">ğŸ˜« STRES: %<span id="u-stress">0</span></div>
        <div class="stat-box">ğŸ•Œ Ä°MAN: %<span id="u-faith">100</span></div>
        <div class="stat-card">ğŸ“… <span id="u-day">Pazartesi</span></div>
    </div>

    <div class="game-grid">
        <div class="panel">
            <button class="nav-btn active" onclick="go('galeri')">ğŸ¢ ANA GALERÄ°</button>
            <button class="nav-btn" onclick="go('sanayi')">ğŸ”§ MODÄ°FÄ°YE MERKEZÄ°</button>
            <button class="nav-btn" onclick="go('mahalle')">ğŸ˜ï¸ MAHALLE & CAMÄ°</button>
            <button class="btn btn-blue" style="margin-top:auto" onclick="nextDay()">ğŸŒ™ GÃœNÃœ BÄ°TÄ°R</button>
        </div>

        <div class="viewport" id="stage">
            <div id="npc-box">
                <div class="bubble" id="chat">"HoÅŸgeldin kral, asfalt aÄŸlamaya hazÄ±r mÄ±?"</div>
                <div style="font-size:80px" id="avatar">ğŸ¤µ</div>
                <h3 id="npc-name" style="color:var(--gold)">Mahmut</h3>
                <div id="actions" style="margin-top:20px; display:flex; flex-direction:column; gap:10px;"></div>
            </div>

            <div id="setup-ui">
                <h2 style="color:var(--gold)">SÃœRÃœÅ MODU</h2>
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <button class="btn btn-blue" onclick="setSpeed(0.4)">YAVAÅ</button>
                    <button class="btn btn-blue" onclick="setSpeed(1.0)">ORTA</button>
                    <button class="btn btn-blue" onclick="setSpeed(2.1)">HIZLI</button>
                </div>
                <button class="btn btn-gold" style="width:100%" onclick="startGame()">KONTAÄI Ã‡EVÄ°R</button>
            </div>

            <div id="drive-hud">
                <h1 id="kmh" style="margin:0; font-size:48px;">0 KM/H</h1>
                <p>A - D TUÅLARI Ä°LE MAKAS AT | ESC Ä°LE DÃ–N</p>
            </div>
            <canvas id="screen"></canvas>
        </div>

        <div class="panel">
            <h3 style="text-align:center; color:var(--gold)">GARAJIM</h3>
            <div id="car-view" style="background:#000; height:150px; border-radius:15px; display:flex; align-items:center; justify-content:center; font-size:60px; border:1px solid #333;">ğŸ¢</div>
            <h4 id="car-name" style="text-align:center; margin:10px 0;">AraÃ§ Yok</h4>
            <p id="car-val" style="text-align:center; color:#888;">â‚º0</p>
            <button class="btn btn-gold" onclick="findNewCar()">ğŸš— YENÄ° ARAÃ‡ ARA</button>
        </div>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
    let state = { money: 500000, stress: 0, faith: 100, day: 0, car: null, loc: 'galeri' };
    let curSpeed = 1.0;
    let playing = false;
    let velocity = 0; // DÃ¶nÃ¼ÅŸ fiziÄŸi iÃ§in

    function go(l) {
        state.loc = l;
        const acts = document.getElementById('actions'); acts.innerHTML = "";
        if(l==='galeri') {
            setNPC("ğŸ¤µ", "Mahmut", "ArabanÄ±n motoru Ä±sÄ±ndÄ±, bekliyor.");
            if(state.car) acts.innerHTML = `<button class="btn btn-gold" onclick="openSetup()">ğŸ TEST SÃœRÃœÅÃœ</button><button class="btn btn-blue" onclick="sellMenu()">ğŸ’° MÃœÅTERÄ°YE SAT</button>`;
        } else if(l==='sanayi') {
            setNPC("ğŸ‘¨â€ğŸ”§", "Sabri Usta", "Rengi mi soldu, jant mÄ± lazÄ±m? Hallederiz.");
            if(state.car) acts.innerHTML = `
                <button class="btn btn-gold" onclick="modify('color')">ğŸ¨ BOYA (â‚º40k)</button>
                <button class="btn btn-blue" onclick="modify('rims')">ğŸ› Ã‡ELÄ°K JANT (â‚º100k)</button>
            `;
        } else if(l==='mahalle') {
            setNPC("ğŸ‘³", "HacÄ± Abi", "Evlat gel namaza, iÃ§in huzur dolsun.");
            acts.innerHTML = `<button class="btn btn-gold" onclick="pray()">ğŸ•Œ NAMAZ KIL</button>`;
        }
        updateUI();
    }

    function modify(type) {
        if(type==='color' && state.money >= 40000) {
            state.money -= 40000; state.car.c = Math.random() * 0xffffff;
            setNPC("ğŸ‘¨â€ğŸ”§", "Sabri", "Yeni rengi fena oldu, piyasasÄ± artar!");
            state.car.p += 60000;
        } else if(type==='rims' && state.money >= 100000) {
            state.money -= 100000; state.car.p += 150000;
            setNPC("ğŸ‘¨â€ğŸ”§", "Sabri", "Jantlar yakÄ±yor, araÃ§ artÄ±k daha heybetli.");
        }
        updateUI();
    }

    function findNewCar() {
        const models = [{n:"Åahin",p:220000,i:"ğŸš—",c:0xffffff},{n:"M4",p:5800000,i:"ğŸï¸",c:0x0033ff},{n:"G63",p:15000000,i:"ğŸšœ",c:0x111111},{n:"Egea",p:900000,i:"ğŸš˜",c:0xaaaaaa}];
        const c = models[Math.floor(Math.random()*models.length)];
        const price = Math.floor(c.p * (0.9 + Math.random()*0.2));
        setNPC("ğŸ‘¤", "Galerici", `${c.n} var elimde, â‚º${price.toLocaleString()} olur.`);
        document.getElementById('actions').innerHTML = `<button class="btn btn-blue" onclick="buyCar('${c.n}',${price},'${c.i}',${c.c})">EL SIKIÅALIM</button>`;
    }

    function buyCar(n,p,i,c) {
        if(state.money >= p) { state.money -= p; state.car = {n,p,i,c}; go('galeri'); } else alert("Para yetersiz!");
    }

    function sellMenu() {
        const p = Math.floor(state.car.p * (0.85 + Math.random()*0.3));
        setNPC("ğŸ¤", "MÃ¼ÅŸteri", `â‚º${p.toLocaleString()} veririm bu makineye.`);
        document.getElementById('actions').innerHTML = `<button class="btn btn-gold" onclick="state.money+=${p}; state.car=null; go('galeri');">SATTIM GÄ°TTÄ°</button>`;
    }

    function pray() { state.faith = 100; state.stress = 0; updateUI(); alert("Ä°man tazelendi."); }
    function nextDay() { state.day++; state.stress = Math.max(0, state.stress-20); alert("Yeni gÃ¼n doÄŸdu."); go('galeri'); }

    function updateUI() {
        document.getElementById('u-money').innerText = state.money.toLocaleString();
        document.getElementById('u-stress').innerText = state.stress;
        document.getElementById('u-faith').innerText = state.faith;
        document.getElementById('u-day').innerText = ["Pazartesi","SalÄ±","Ã‡arÅŸamba","PerÅŸembe","Cuma","Cumartesi","Pazar"][state.day % 7];
        if(state.car) {
            document.getElementById('car-view').innerText = state.car.i;
            document.getElementById('car-name').innerText = state.car.n;
            document.getElementById('car-val').innerText = "â‚º" + state.car.p.toLocaleString();
        }
    }
    function setNPC(a,n,t) { document.getElementById('avatar').innerText=a; document.getElementById('npc-name').innerText=n; document.getElementById('chat').innerText=`"${t}"`; }

    // --- PRO 3D ENGINE ---
    const canvas = document.getElementById('screen');
    const scene = new THREE.Scene(); scene.fog = new THREE.Fog(0, 5, 120);
    const camera = new THREE.PerspectiveCamera(70, 2, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });

    const road = new THREE.Mesh(new THREE.PlaneGeometry(20, 500), new THREE.MeshStandardMaterial({color: 0x111111}));
    road.rotation.x = -Math.PI/2; scene.add(road);
    const lines = [];
    for(let i=0; i<40; i++) {
        let l = new THREE.Mesh(new THREE.PlaneGeometry(0.5, 10), new THREE.MeshBasicMaterial({color:0xffffff}));
        l.rotation.x = -Math.PI/2; l.position.set(0, 0.02, -i*25);
        scene.add(l); lines.push(l);
    }
    
    const carGroup = new THREE.Group();
    function build3D() {
        carGroup.clear();
        const body = new THREE.Mesh(new THREE.BoxGeometry(2, 0.8, 4), new THREE.MeshStandardMaterial({color: state.car.c}));
        body.position.y = 0.6;
        const headL = new THREE.SpotLight(0xffffff, 50, 60, 0.4); headL.position.set(0.8, 0.8, -2);
        const headR = new THREE.SpotLight(0xffffff, 50, 60, 0.4); headR.position.set(-0.8, 0.8, -2);
        carGroup.add(body, headL, headR, headL.target, headR.target);
    }
    scene.add(carGroup, new THREE.AmbientLight(0xffffff, 0.3));
    camera.position.set(0, 8, 15); camera.lookAt(0,0,-5);

    let enemies = [];
    function spawnEnemy() {
        const e = new THREE.Mesh(new THREE.BoxGeometry(2, 0.9, 4), new THREE.MeshStandardMaterial({color: 0x333333}));
        e.position.set((Math.random()-0.5)*16, 0.6, -200);
        scene.add(e); enemies.push(e);
    }

    function openSetup() { document.getElementById('setup-ui').style.display='block'; }
    function setSpeed(s) { curSpeed = s; }

    function startGame() {
        document.getElementById('setup-ui').style.display='none'; document.getElementById('npc-box').style.display='none';
        canvas.style.display='block'; document.getElementById('drive-hud').style.display='block';
        playing = true; build3D(); loop();
    }

    function loop() {
        if(!playing) return; requestAnimationFrame(loop);
        
        // AkÄ±ÅŸ hÄ±zÄ±
        lines.forEach(l => { l.position.z += curSpeed * 15; if(l.position.z > 30) l.position.z = -400; });
        
        // FOV DinamiÄŸi
        camera.fov = 70 + (curSpeed * 10); camera.updateProjectionMatrix();

        // Trafik FiziÄŸi
        if(Math.random() < 0.04) spawnEnemy();
        enemies.forEach((e, i) => {
            e.position.z += curSpeed * 18;
            if(Math.abs(e.position.z - carGroup.position.z) < 4 && Math.abs(e.position.x - carGroup.position.x) < 2) {
                playing = false; alert("KAZA! AraÃ§ aÄŸÄ±r hasar aldÄ±."); state.car.p *= 0.6; state.stress = 100; stopGame();
            }
            if(e.position.z > 20) { scene.remove(e); enemies.splice(i, 1); }
        });

        // Direksiyon FiziÄŸi (Ä°vmeli)
        carGroup.position.x += velocity;
        carGroup.rotation.z = -velocity * 0.5; // DÃ¶nÃ¼ÅŸte yana yatma
        velocity *= 0.92; // SÃ¼rtÃ¼nme

        document.getElementById('kmh').innerText = Math.floor(curSpeed * 180) + " KM/H";
        renderer.render(scene, camera);
    }

    function stopGame() {
        playing = false; canvas.style.display='none'; document.getElementById('drive-hud').style.display='none';
        document.getElementById('npc-box').style.display='block'; enemies.forEach(e=>scene.remove(e)); enemies=[];
        go('galeri');
    }

    window.addEventListener('keydown', (e) => {
        if(!playing) return;
        if(e.key === 'a' || e.key === 'ArrowLeft') velocity -= 0.15;
        if(e.key === 'd' || e.key === 'ArrowRight') velocity += 0.15;
        if(e.key === 'Escape') stopGame();
    });

    go('galeri');
</script>
</body>
</html>
