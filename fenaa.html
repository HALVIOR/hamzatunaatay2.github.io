<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Galeri Baronu: YeraltÄ± (FIXED)</title>
    <style>
        :root { --neon: #00f2ff; --pink: #ff007f; --gold: #ffd700; --dark: #050505; }
        body { margin: 0; background: var(--dark); color: #fff; font-family: 'Courier New', monospace; overflow: hidden; }
        
        /* HUD & UI - En Ã¼st katman */
        #hud { position: fixed; top: 0; width: 100%; height: 50px; display: flex; align-items: center; justify-content: space-around; background: #000; z-index: 9999; border-bottom: 2px solid var(--neon); }
        .stat { font-size: 16px; font-weight: bold; color: #fff; }
        .stat span { color: var(--gold); }

        /* ANA YAPI */
        #game { display: grid; grid-template-columns: 300px 1fr; height: 100vh; padding-top: 50px; }
        
        /* SOL MENÃœ - TÄ±klama sorunu Ã§Ã¶zÃ¼ldÃ¼ (z-index arttÄ±rÄ±ldÄ±) */
        #sidebar { 
            background: #0f0f0f; 
            border-right: 1px solid #333; 
            padding: 10px; 
            overflow-y: auto; 
            z-index: 5000; /* Ã‡OK Ã–NEMLÄ°: MenÃ¼yÃ¼ en Ã¶ne aldÄ±k */
            position: relative;
            box-shadow: 5px 0 15px rgba(0,0,0,0.5);
        }

        /* Responsive: Mobilde menÃ¼ aÅŸaÄŸÄ± inmesin, sabit kalsÄ±n */
        @media (max-width: 768px) {
            #game { grid-template-columns: 1fr; grid-template-rows: 40% 60%; }
            #sidebar { border-right: none; border-bottom: 2px solid var(--neon); }
        }

        .btn { 
            background: #222; 
            border: 1px solid #555; 
            color: #eee; 
            padding: 12px; 
            width: 100%; 
            margin-bottom: 8px; 
            cursor: pointer; 
            font-weight: bold; 
            text-align: left; 
            transition: 0.2s;
            position: relative;
            z-index: 5001; /* Butonlar kesinlikle tÄ±klanabilir olsun */
        }
        .btn:hover { background: #333; border-color: var(--neon); color: var(--neon); transform: translateX(5px); }
        .btn:active { background: var(--neon); color: #000; transform: scale(0.98); }
        .btn.danger { border-color: var(--pink); color: var(--pink); }
        .btn.danger:hover { background: var(--pink); color: #fff; }

        /* OYUN ALANI */
        #viewport { position: relative; background: #000; overflow: hidden; width: 100%; height: 100%; }
        canvas { width: 100%; height: 100%; display: block; outline: none; }
        
        /* OFÄ°S ARAYÃœZÃœ - GÃ¶rÃ¼nmez duvar kaldÄ±rÄ±ldÄ± */
        #office-layer { 
            position: absolute; 
            inset: 0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            z-index: 10; 
            pointer-events: none; /* Ã–NEMLÄ°: BoÅŸluklara tÄ±klayÄ±nca arkaya geÃ§sin */
        }
        
        /* Ä°Ã§erik kutusu tÄ±klanabilir olsun */
        .dialog-container {
            pointer-events: auto; /* Kutunun iÃ§i tÄ±klanabilir */
            background: rgba(0,0,0,0.9);
            padding: 20px;
            border: 2px solid var(--neon);
            border-radius: 10px;
            text-align: center;
            width: 80%;
            max-width: 500px;
        }

        .action-row { margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
        
        /* GARAJ */
        .car-item { background: #1a1a1a; padding: 8px; border-left: 3px solid var(--gold); margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .sell-btn { background: var(--gold); border: none; padding: 5px 10px; cursor: pointer; font-weight: bold; color: #000; }
        .sell-btn:hover { background: #fff; }

        /* TELEFON */
        #phone { position: fixed; bottom: -600px; right: 20px; width: 250px; height: 400px; background: #111; border: 4px solid #444; border-radius: 15px; transition: 0.4s; z-index: 9999; padding: 15px; display: flex; flex-direction: column; }
        #phone.open { bottom: 20px; }
        .app-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .app { background: #333; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 10px; cursor: pointer; font-size: 24px; }
        .app:hover { background: #444; }

        /* NOTIFICATION */
        #notif { position: fixed; top: 60px; right: -300px; background: var(--pink); color: #fff; padding: 15px; z-index: 10000; font-weight: bold; transition: 0.3s; }
        #notif.active { right: 20px; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="hud">
    <div class="stat">ğŸ’µ <span id="money">0</span>â‚º</div>
    <div class="stat">ğŸ‘‘ Ä°tibar: <span id="rep">0</span></div>
    <div class="stat">âš¡ Enerji: <span id="energy">100</span></div>
    <button onclick="saveGame()" style="background:#333; color:#fff; border:1px solid #555; padding:5px 10px; cursor:pointer;">KAYDET</button>
</div>

<div id="game">
    <div id="sidebar">
        <h4 style="color:var(--neon); margin-top:0;">OFÄ°S Ä°ÅLERÄ°</h4>
        <button class="btn" onclick="switchMode('office')">ğŸ¤ MÃœÅTERÄ° KABUL</button>
        <button class="btn" onclick="startDrive()">ğŸï¸ ÅEHÄ°R TURU (SÃ¼r)</button>
        <button class="btn" onclick="visitImam()">ğŸ•Œ CUMA SOHBETÄ°</button>
        <button class="btn danger" onclick="togglePhone()">ğŸ“± "Ã–ZEL" TELEFON</button>
        
        <hr style="border-color:#333; margin: 15px 0;">
        <h4 style="color:var(--gold); margin-bottom:10px;">GARAJIM</h4>
        <div id="garage-list">YÃ¼kleniyor...</div>
    </div>

    <div id="viewport">
        <canvas id="stage"></canvas>
        <div id="speedometer" style="position:absolute; bottom:20px; left:20px; font-size:30px; color:var(--neon); font-family:Arial; font-weight:bold; display:none; z-index:100;">0 KM/H</div>

        <div id="office-layer">
            <div class="dialog-container">
                <div style="font-size:60px; margin-bottom:10px;">ğŸ‘¤</div>
                <div id="npc-text" style="font-size:18px; margin-bottom:15px;">"MÃ¼ÅŸteri bekleniyor..."</div>
                <div class="action-row" id="trade-btns">
                    </div>
            </div>
        </div>
    </div>
</div>

<div id="phone">
    <div style="text-align:center; color:#888; border-bottom:1px solid #333; padding-bottom:5px;">DOSTCELL</div>
    <div class="app-grid">
        <div class="app" onclick="notify('AradÄ±ÄŸÄ±nÄ±z numara kullanÄ±lmamaktadÄ±r.')">ğŸ“</div>
        <div class="app" onclick="notify('Borsa dÃ¼ÅŸtÃ¼ reis.')">ğŸ“‰</div>
        <div class="app" onclick="notify('Mesaj: AkÅŸama eve erken gel.')">ğŸ’¬</div>
        <div class="app" style="background:var(--pink)" onclick="alert('POLÄ°S TELSÄ°ZÄ°: BÃ¶lgede hareketlilik var!')">ğŸš¨</div>
    </div>
    <button onclick="togglePhone()" style="margin-top:auto; background:#222; color:#fff; border:none; padding:10px; cursor:pointer;">KAPAT</button>
</div>

<div id="notif">Bildirim</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
    // --- OYUN MANTIÄI ---
    const CAR_MODELS = [
        { name: "TofaÅŸ Åahin", price: 200000, speed: 0.7 },
        { name: "BMW E30", price: 450000, speed: 1.0 },
        { name: "Honda Civic", price: 800000, speed: 1.2 },
        { name: "VW Passat", price: 1500000, speed: 1.1 },
        { name: "Mercedes S", price: 5000000, speed: 1.4 }
    ];

    let state = { money: 500000, rep: 10, energy: 100, garage: [] };
    let currentOffer = null;
    let isDriving = false;

    // BaÅŸlangÄ±Ã§
    window.onload = function() {
        if(localStorage.getItem('mafiaSaveV2')) {
            state = JSON.parse(localStorage.getItem('mafiaSaveV2'));
            notify("KayÄ±t yÃ¼klendi patron.");
        }
        init3D();
        updateUI();
        generateCustomer();
    };

    function saveGame() {
        localStorage.setItem('mafiaSaveV2', JSON.stringify(state));
        notify("Oyun kaydedildi!");
    }

    function updateUI() {
        document.getElementById('money').innerText = state.money.toLocaleString('tr-TR');
        document.getElementById('rep').innerText = state.rep;
        document.getElementById('energy').innerText = state.energy;

        const list = document.getElementById('garage-list');
        list.innerHTML = "";
        if(state.garage.length === 0) list.innerHTML = "<div style='color:#666; font-size:12px;'>Garaj boÅŸ.</div>";
        
        state.garage.forEach((car, i) => {
            // onclick iÃ§indeki tÄ±rnak iÅŸaretlerine dikkat
            list.innerHTML += `
            <div class="car-item">
                <div style="font-size:12px;">
                    <div style="color:#fff">${car.name}</div>
                    <div style="color:#888">${car.boughtPrice.toLocaleString()}â‚º</div>
                </div>
                <button class="sell-btn" onclick="sellCar(${i})">SAT</button>
            </div>`;
        });
    }

    function notify(msg) {
        const n = document.getElementById('notif');
        n.innerText = msg;
        n.classList.add('active');
        setTimeout(() => n.classList.remove('active'), 3000);
    }

    function switchMode(mode) {
        if(mode === 'office') {
            document.getElementById('office-layer').classList.remove('hidden');
            document.getElementById('speedometer').style.display = 'none';
            isDriving = false;
            generateCustomer();
        } 
    }

    function startDrive() {
        if(state.garage.length === 0) {
            notify("Araban yok! Ã–nce araba al.");
            return;
        }
        document.getElementById('office-layer').classList.add('hidden');
        document.getElementById('speedometer').style.display = 'block';
        isDriving = true;
        
        // ArabayÄ± sÄ±fÄ±rla
        playerCar.position.set(0, 0.5, 0);
        playerCar.rotation.set(0, 0, 0);
        speed = 0;
        
        // OdaÄŸÄ± canvas'a ver ki tuÅŸlar Ã§alÄ±ÅŸsÄ±n
        document.getElementById('stage').focus();
    }

    function generateCustomer() {
        const base = CAR_MODELS[Math.floor(Math.random() * CAR_MODELS.length)];
        // Fiyat deÄŸiÅŸkenliÄŸi
        const price = Math.floor(base.price * (0.8 + Math.random() * 0.4));
        
        currentOffer = { name: base.name, price: price, data: base };
        
        document.getElementById('npc-text').innerText = 
            `"Selam usta. Elimde bir ${base.name} var. ${price.toLocaleString()}â‚º istiyorum. Ne dersin?"`;
            
        document.getElementById('trade-btns').innerHTML = `
            <button class="btn" style="width:auto; background:var(--neon); color:#000;" onclick="trade('buy')">AL</button>
            <button class="btn danger" style="width:auto;" onclick="trade('reject')">KOV</button>
        `;
    }

    function trade(action) {
        if(action === 'buy') {
            if(state.money >= currentOffer.price) {
                state.money -= currentOffer.price;
                state.garage.push({
                    name: currentOffer.name,
                    boughtPrice: currentOffer.price,
                    speed: currentOffer.data.speed
                });
                notify("HayÄ±rlÄ± olsun!");
                state.rep += 5;
            } else {
                notify("Paran yetersiz!");
            }
        } else {
            notify("MÃ¼ÅŸteri gÃ¶nderildi.");
        }
        updateUI();
        generateCustomer();
    }

    function sellCar(index) {
        const car = state.garage[index];
        const sellPrice = Math.floor(car.boughtPrice * (1.1 + Math.random() * 0.2)); // KÃ¢r marjÄ±
        
        if(confirm(`${car.name} aracÄ±nÄ± ${sellPrice.toLocaleString()}â‚º fiyatÄ±na satÄ±yor musun?`)) {
            state.money += sellPrice;
            state.garage.splice(index, 1);
            state.rep += 2;
            notify("SatÄ±ÅŸ baÅŸarÄ±lÄ±! Para kasada.");
            updateUI();
        }
    }

    function visitImam() {
        state.energy = 100;
        notify("Ä°Ã§ huzura erdin. Enerji fullendi.");
        updateUI();
    }

    function togglePhone() {
        document.getElementById('phone').classList.toggle('open');
    }

    // --- THREE.JS (SÃœRÃœÅ) ---
    let scene, camera, renderer, playerCar;
    let speed = 0, angle = 0;
    let keys = {};

    function init3D() {
        const canvas = document.getElementById('stage');
        renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
        renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111111);
        
        camera = new THREE.PerspectiveCamera(60, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
        camera.position.set(0, 5, -10);

        // IÅŸÄ±k
        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(10, 20, 10);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0x404040));

        // Zemin
        const grid = new THREE.GridHelper(1000, 100, 0x00f2ff, 0x222222);
        scene.add(grid);

        // Binalar
        const geo = new THREE.BoxGeometry(1, 1, 1);
        const mat = new THREE.MeshStandardMaterial({ color: 0x333 });
        for(let i=0; i<100; i++) {
            const b = new THREE.Mesh(geo, mat);
            b.position.set((Math.random()-0.5)*200, 0, (Math.random()-0.5)*200);
            b.scale.set(5, Math.random()*20+5, 5);
            b.position.y = b.scale.y / 2;
            scene.add(b);
        }

        // Oyuncu AracÄ±
        playerCar = new THREE.Mesh(
            new THREE.BoxGeometry(2, 1, 4),
            new THREE.MeshStandardMaterial({ color: 0xffd700 })
        );
        playerCar.position.y = 0.5;
        scene.add(playerCar);

        // Kontroller
        window.addEventListener('keydown', (e) => keys[e.key] = true);
        window.addEventListener('keyup', (e) => keys[e.key] = false);

        animate();
    }

    function animate() {
        requestAnimationFrame(animate);

        if(isDriving) {
            if(keys['w'] || keys['W']) speed += 0.01;
            else if(keys['s'] || keys['S']) speed -= 0.01;
            else speed *= 0.95;

            speed = Math.max(Math.min(speed, 1.5), -0.5);

            if(Math.abs(speed) > 0.01) {
                if(keys['a'] || keys['A']) angle += 0.05;
                if(keys['d'] || keys['D']) angle -= 0.05;
            }

            playerCar.rotation.y = angle;
            playerCar.position.x += Math.sin(angle) * speed;
            playerCar.position.z += Math.cos(angle) * speed;

            // Kamera takibi
            camera.position.x = playerCar.position.x - Math.sin(angle) * 10;
            camera.position.z = playerCar.position.z - Math.cos(angle) * 10;
            camera.lookAt(playerCar.position);

            document.getElementById('speedometer').innerText = Math.floor(speed * 100) + " KM/H";
        } else {
            // Ofis modu kamerasÄ± dÃ¶nsÃ¼n
            camera.position.x = Math.sin(Date.now()*0.0005) * 20;
            camera.position.z = Math.cos(Date.now()*0.0005) * 20;
            camera.lookAt(0,0,0);
        }
        
        renderer.render(scene, camera);
    }
    
    // Resize fix
    window.addEventListener('resize', () => {
        const c = document.getElementById('stage');
        camera.aspect = c.clientWidth / c.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(c.clientWidth, c.clientHeight);
    });

</script>
</body>
</html>
